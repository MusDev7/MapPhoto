<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国照片地图 - 增强版</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            transition: filter 0.3s ease;
        }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }
        
        .photo-marker {
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        .photo-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        .photo-marker img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .photo-cluster {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .photo-cluster:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        .cluster-photo {
            position: absolute;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .cluster-photo img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .cluster-count {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        
        .photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .photo-container {
            position: relative;
            width: 90%;
            height: 70%;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .photo-display {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .main-photo {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.25);
        }
        
        .photo-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            pointer-events: none;
        }
        
        .nav-btn {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 24px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn:hover {
            background-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 20px;
            cursor: pointer;
            z-index: 1010;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .close-btn:hover {
            background-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 修改后的工具栏样式 */
        .photo-toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: transparent;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            background-color: rgba(44, 62, 80, 0.85);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .toolbar-btn:hover {
            background-color: #34495e;
            transform: translateY(-2px);
        }
        
        .toolbar-btn.delete-btn {
            background-color: rgba(231, 76, 60, 0.85);
        }
        
        .toolbar-btn.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .photo-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .preview-item {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }
        
        .preview-item:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        .preview-item.active {
            opacity: 1;
            border: 2px solid #3498db;
            transform: scale(1.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-count-indicator {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .total-photo-count {
            margin-left: 10px;
            padding: 4px 10px;
            background-color: #2c3e50;
            color: white;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .navbar {
            z-index: 1000;
        }
        
        .tooltip {
            font-size: 14px;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .layer-control {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        /* 右键菜单样式 */
        .custom-context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px 0;
        }
        
        .custom-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .custom-context-menu li {
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .custom-context-menu li:hover {
            background-color: #f0f0f0;
        }
        
        /* 详情面板 */
        .photo-details {
            position: absolute;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .photo-details.open {
            right: 0;
        }
        
        .photo-details h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-item label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #7f8c8d;
        }
        
        .detail-item .value {
            color: 2c3e50;
        }
        
        /* 进度条样式 */
        .progress-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            min-width: 300px;
            text-align: center;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 搜索标记样式 */
        .search-marker {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .photo-container {
                width: 95%;
                height: 60%;
            }
            
            .photo-details {
                width: 280px;
            }
            
            .photo-toolbar {
                flex-wrap: wrap;
            }
            
            .photo-preview {
                flex-wrap: wrap;
                max-width: 90%;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .navbar .btn {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            #search-input {
                max-width: 150px !important;
            }
        }
		/* 添加导出选项样式 */
        .export-options {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            min-width: 300px;
        }
        
        .export-options h5 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .export-options .form-check {
            margin-bottom: 15px;
        }
        
        .export-options .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
		.navbar-hidden {
			transform: translateY(-100%);
			transition: transform 0.3s ease;
		}

		/* 调整Leaflet缩放控件位置 */
		.leaflet-top.leaflet-left {
			top: 80px; /* 将缩放控件下移，避免与隐藏的导航栏冲突 */
		}

		/* 隐藏缩放控件的类 */
		.leaflet-control-zoom-hidden {
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}
    </style>
</head>
<body>
	<!-- 地图蒙版 -->
    <div class="map-overlay" id="mapOverlay"></div>
	
	<!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">中国照片地图 - 增强版</span>
            
            <!-- 添加搜索框 -->
            <div class="d-flex align-items-center me-3">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="输入地址进行搜索..." style="max-width: 250px;">
                    <button class="btn btn-outline-primary" type="button" onclick="searchLocation()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="清除搜索标记">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="d-flex">
                <input type="file" id="photo-upload" multiple accept="image/*" style="display: none;">
                <button class="btn btn-primary me-2" onclick="document.getElementById('photo-upload').click()">
                    <i class="fas fa-plus"></i> 添加照片
                </button>
                <button class="btn btn-success me-2" onclick="exportData()">
                    <i class="fas fa-download"></i> 导出
                </button>
                <button class="btn btn-info me-2" onclick="document.getElementById('import-file').click()">
                    <i class="fas fa-upload"></i> 加载
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(this.files)">
                <button class="btn btn-outline-secondary" onclick="clearAllPhotos()">
                    <i class="fas fa-trash"></i> 清除
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 地图容器 -->
    <div id="map"></div>
    

    
    <!-- 照片查看器 -->
    <div class="photo-viewer" id="photoViewer">
        <div class="close-btn" onclick="closePhotoViewer()">
            <i class="fas fa-times"></i>
        </div>
        
        <div class="photo-container">
            <div class="photo-display">
                <img class="main-photo" id="mainPhoto" src="" alt="Photo">
            </div>
        </div>
        
        <div class="photo-controls">
            <div class="nav-btn prev-btn" onclick="navigatePhoto(-1)">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="nav-btn next-btn" onclick="navigatePhoto(1)">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <div class="photo-toolbar">
            <button class="toolbar-btn delete-btn" onclick="deleteCurrentPhoto()">
                <i class="fas fa-trash"></i> 删除
            </button>
            <button class="toolbar-btn" onclick="toggleDetails()">
                <i class="fas fa-info-circle"></i> 详情
            </button>
            <button class="toolbar-btn" onclick="downloadCurrentPhoto()">
                <i class="fas fa-download"></i> 下载
            </button>
        </div>
        
        <div class="photo-preview" id="photoPreview">
            <!-- 预览小图将通过JS动态添加 -->
        </div>
        
        <div class="photo-details" id="photoDetails">
            <h3>照片详情</h3>
            <div class="detail-item">
                <label>位置</label>
                <div class="value" id="detailLocation"></div>
            </div>
            <div class="detail-item">
                <label>尺寸</label>
                <div class="value" id="detailDimensions"></div>
            </div>
            <div class="detail-item">
                <label>文件名称</label>
                <div class="value" id="detailFilename"></div>
            </div>
            <div class="detail-item">
                <label>添加时间</label>
                <div class="value" id="detailTimestamp"></div>
            </div>
        </div>
    </div>
    
    <!-- 进度提示框 -->
    <div class="progress-container" id="progressContainer">
        <h5 id="progressTitle">处理中</h5>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressMessage">请稍候...</p>
    </div>
    
    <!-- 右键菜单 -->
    <div id="context-menu" class="custom-context-menu">
        <ul>
            <li onclick="addPhotoAtContextMenuLocation()">在此处添加照片</li>
            <li onclick="hideContextMenu()">取消</li>
        </ul>
    </div>
    
    <!-- 图层控制 -->
<!--     <div class="layer-control">
        <h6>图层控制</h6>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="road-layer">
            <label class="form-check-label" for="road-layer">
                显示路网
            </label>
        </div>
    </div> -->

    <!-- 坐标输入模态框 -->
    <div class="modal fade" id="coordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">请输入照片位置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>照片中没有找到位置信息，请手动输入坐标：</p>
                    <div class="mb-3">
                        <label for="latitude" class="form-label">纬度</label>
                        <input type="number" class="form-control" id="latitude" min="-90" max="90" step="0.000001">
                    </div>
                    <div class="mb-3">
                        <label for="longitude" class="form-label">经度</label>
                        <input type="number" class="form-control" id="longitude" min="-180" max="180" step="0.000001">
                    </div>
                    <p class="text-muted">或者点击地图选择位置</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmCoordinates()">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script type="text/javascript">
	  window._AMapSecurityConfig = {
		securityJsCode: "8e55bf1a7df0ff0554ce202ec395b181",
	  };
	</script>
    <script>
        // 全局变量
        let map;
        let photoMarkers = [];
        let photoClusters = {};
        let currentPhoto = null;
        let pendingPhotos = [];
        let baseLayers = {};
        let roadLayer;
        let contextMenuLocation = null;
        let searchMarker = null; // 搜索标记
        let amapKey = '	fe4d710bb0b7ecb71c69ca60b9963e6d'; // 请替换为您的高德地图API密钥
        
        // 照片查看器相关变量
        let currentViewerMarkers = [];
        let currentPhotoIndex = 0;
        let isDetailsOpen = false;
        
        // 瓦片缓存相关变量
        let tileCache = {};
        const CACHE_DB_NAME = 'MapTileCache';
        const CACHE_STORE_NAME = 'tiles';
        let db = null;
        
        // 初始化地图
        function initMap() {
            // 创建地图实例，设置中心点和缩放级别
            map = L.map('map').setView([35.8617, 104.1954], 5); // 中国中心点
            
            // 使用高德地图瓦片
            baseLayers.standard = L.tileLayer('https://webrd04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
                maxZoom: 19
            }).addTo(map);
            
            // 添加路网图层（默认不添加到地图）
            //roadLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            //    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
            //    maxZoom: 19
            //});
            
            // 监听路网图层复选框变化
            //document.getElementById('road-layer').addEventListener('change', function(e) {
            //    if (e.target.checked) {
            //        roadLayer.addTo(map);
            //    } else {
            //        map.removeLayer(roadLayer);
            //    }
            //});
            
            // 监听搜索框的回车键
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            // 初始化瓦片缓存数据库
            initTileCacheDB();
            
            // 添加点击地图选择位置的功能
            map.on('click', function(e) {
                if (pendingPhotos.length > 0) {
                    document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                    document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                    
                    // 自动显示坐标输入模态框
                    const coordModal = new bootstrap.Modal(document.getElementById('coordModal'));
                    coordModal.show();
                }
                
                // 点击地图时隐藏右键菜单
                hideContextMenu();
            });
            
            // 监听文件选择事件
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            // 监听右键点击事件
            map.on('contextmenu', function(e) {
                // 阻止默认的右键菜单
                e.originalEvent.preventDefault();
                
                // 显示自定义右键菜单
                showContextMenu(e.originalEvent.clientX, e.originalEvent.clientY, e.latlng);
            });
            
            // 点击页面其他区域时隐藏右键菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-context-menu')) {
                    hideContextMenu();
                }
            });
            
            // 监听ESC键关闭照片查看器
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoViewer();
                } else if (e.key === 'ArrowLeft') {
                    navigatePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePhoto(1);
                }
            });
            
            // 监听地图移动和缩放事件，缓存瓦片
            map.on('moveend', cacheVisibleTiles);
            map.on('zoomend', cacheVisibleTiles);
        }
        
        // 搜索位置函数
        function searchLocation() {
            const address = document.getElementById('search-input').value.trim();
            if (!address) {
                alert('请输入要搜索的地址');
                return;
            }
            
            showProgress('地址搜索', '正在搜索地址...', 0);
            
            // 使用高德地图地理编码API
            const encodedAddress = encodeURIComponent(address);
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodedAddress}&output=JSON&key=${amapKey}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location;
                        const [lng, lat] = location.split(',').map(Number);
                        
                        // 移动到搜索到的位置
                        map.setView([lat, lng], 15);
                        
                        // 清除之前的搜索标记
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }
                        
                        // 添加新标记
                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'search-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 30px;"></i>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map);
                        
                        // 添加弹出窗口
                        searchMarker.bindPopup(`
                            <div style="text-align: center;">
                                <strong>${data.geocodes[0].formatted_address}</strong><br>
                                <small>${data.geocodes[0].province} ${data.geocodes[0].city} ${data.geocodes[0].district}</small>
                            </div>
                        `).openPopup();
                        
                        hideProgress();
                    } else {
                        hideProgress();
                        alert('未找到该地址，请尝试更具体的地址描述');
                    }
                })
                .catch(error => {
                    hideProgress();
                    console.error('搜索失败:', error);
                    alert('搜索失败，请检查网络连接或稍后重试');
                });
        }
        
        // 清除搜索标记
        function clearSearch() {
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
            document.getElementById('search-input').value = '';
        }
        
        // 初始化瓦片缓存数据库
        function initTileCacheDB() {
            const request = indexedDB.open(CACHE_DB_NAME, 1);
            
            request.onerror = function(event) {
                console.error("IndexedDB数据库打开失败:", event.target.error);
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains(CACHE_STORE_NAME)) {
                    const store = db.createObjectStore(CACHE_STORE_NAME, { keyPath: 'key' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                // 加载已缓存的瓦片
                loadCachedTiles();
            };
        }
        
        // 缓存当前可见区域的瓦片
        function cacheVisibleTiles() {
            if (!db) return;
            
            const bounds = map.getBounds();
            const zoom = map.getZoom();
            const tileBounds = L.bounds(
                map.project(bounds.getNorthWest(), zoom).divideBy(256).floor(),
                map.project(bounds.getSouthEast(), zoom).divideBy(256).floor()
            );
            
            const minX = tileBounds.min.x;
            const maxX = tileBounds.max.x;
            const minY = tileBounds.min.y;
            const maxY = tileBounds.max.y;
            
            for (let x = minX; x <= maxX; x++) {
                for (let y = minY; y <= maxY; y++) {
                    const tileUrl = `https://webrd04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x=${x}&y=${y}&z=${zoom}`;
                    cacheTile(tileUrl, x, y, zoom);
                }
            }
        }
        
        // 缓存单个瓦片
        function cacheTile(url, x, y, z) {
            const key = `${z}/${x}/${y}`;
            
            // 检查是否已缓存
            const transaction = db.transaction([CACHE_STORE_NAME], 'readonly');
            const store = transaction.objectStore(CACHE_STORE_NAME);
            const request = store.get(key);
            
            request.onsuccess = function() {
                if (!request.result) {
                    // 未缓存，获取并保存瓦片
                    fetch(url)
                        .then(response => response.blob())
                        .then(blob => {
                            const transaction = db.transaction([CACHE_STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(CACHE_STORE_NAME);
                            store.put({
                                key: key,
                                blob: blob,
                                timestamp: Date.now(),
                                url: url,
                                x: x,
                                y: y,
                                z: z
                            });
                        })
                        .catch(error => console.error('瓦片获取失败:', error));
                }
            };
        }
        
        // 加载已缓存的瓦片
        function loadCachedTiles() {
            if (!db) return;
            
            const transaction = db.transaction([CACHE_STORE_NAME], 'readonly');
            const store = transaction.objectStore(CACHE_STORE_NAME);
            const request = store.getAll();
            
            request.onsuccess = function() {
                request.result.forEach(item => {
                    tileCache[item.key] = URL.createObjectURL(item.blob);
                });
            };
        }
        
        // 显示进度提示
        function showProgress(title, message, percent) {
            const container = document.getElementById('progressContainer');
            const titleEl = document.getElementById('progressTitle');
            const messageEl = document.getElementById('progressMessage');
            const fillEl = document.getElementById('progressFill');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            fillEl.style.width = percent + '%';
            container.style.display = 'block';
        }
        
        // 隐藏进度提示
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // 导出数据
        function exportData() {
            showProgress('导出数据', '准备导出数据...', 0);
            
            // 收集照片数据
            const photoData = photoMarkers.map(marker => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function() {
                        resolve({
                            dataUrl: reader.result,
                            lat: marker.photoData.lat,
                            lng: marker.photoData.lng,
                            width: marker.photoData.width,
                            height: marker.photoData.height,
                            filename: marker.photoData.file.name,
                            timestamp: marker.photoData.timestamp
                        });
                    };
                    reader.readAsDataURL(marker.photoData.file);
                });
            });
            
            // 收集地图状态
            const center = map.getCenter();
            const zoom = map.getZoom();
            const mapState = {
                center: { lat: center.lat, lng: center.lng },
                zoom: zoom,
                //roadLayerVisible: document.getElementById('road-layer').checked
            };
            
            // 收集瓦片缓存数据
            showProgress('导出数据', '收集瓦片缓存数据...', 30);
            
            const tilePromises = [];
            if (db) {
                const transaction = db.transaction([CACHE_STORE_NAME], 'readonly');
                const store = transaction.objectStore(CACHE_STORE_NAME);
                const request = store.getAll();
                
                tilePromises.push(new Promise((resolve) => {
                    request.onsuccess = function() {
                        const tiles = request.result.map(item => {
                            return new Promise((resolveTile) => {
                                const reader = new FileReader();
                                reader.onload = function() {
                                    resolveTile({
                                        key: item.key,
                                        data: reader.result,
                                        x: item.x,
                                        y: item.y,
                                        z: item.z,
                                        url: item.url,
                                        timestamp: item.timestamp
                                    });
                                };
                                reader.readAsDataURL(item.blob);
                            });
                        });
                        
                        Promise.all(tiles).then(resolve);
                    };
                }));
            }
            
            // 等待所有数据收集完成
            showProgress('导出数据', '处理照片数据...', 60);
            
            Promise.all([
                Promise.all(photoData),
                Promise.all(tilePromises).then(results => results.flat())
            ]).then(([photos, tiles]) => {
                showProgress('导出数据', '生成导出文件...', 90);
                
                // 创建导出数据对象
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    photos: photos,
                    mapState: mapState,
                    tiles: tiles
                };
                
                // 转换为JSON字符串
                const jsonData = JSON.stringify(exportData);
                
                // 创建下载链接
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `photo-map-export-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideProgress();
            });
        }
        
        // 导入数据
        function importData(files) {
            if (!files || files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (!data.photos || !data.mapState) {
                        throw new Error('无效的数据文件格式');
                    }
                    
                    showProgress('导入数据', '准备导入数据...', 0);
                    
                    // 清除现有数据
                    clearAllPhotos();
                    
                    // 恢复地图状态
                    //map.setView([data.mapState.center.lat, data.mapState.center.lng], data.mapState.zoom);
                    //document.getElementById('road-layer').checked = data.mapState.roadLayerVisible;
                    //if (data.mapState.roadLayerVisible) {
                    //    roadLayer.addTo(map);
                    //}
                    
                    // 恢复瓦片缓存
                    if (data.tiles && data.tiles.length > 0) {
                        showProgress('导入数据', '恢复瓦片缓存...', 20);
                        restoreTiles(data.tiles);
                    }
                    
                    // 恢复照片
                    showProgress('导入数据', '恢复照片数据...', 50);
                    restorePhotos(data.photos, data.photos.length);
                    
                } catch (error) {
                    console.error('导入数据失败:', error);
                    alert('导入数据失败: ' + error.message);
                    hideProgress();
                }
            };
            
            reader.readAsText(file);
        }
        
        // 恢复瓦片缓存
        function restoreTiles(tiles) {
            if (!db) return Promise.resolve();
            
            const transaction = db.transaction([CACHE_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(CACHE_STORE_NAME);
            
            // 清空现有缓存
            store.clear();
            
            // 添加新缓存
            const promises = tiles.map(tile => {
                return new Promise((resolve) => {
                    fetch(tile.data)
                        .then(res => res.blob())
                        .then(blob => {
                            store.put({
                                key: tile.key,
                                blob: blob,
                                timestamp: tile.timestamp,
                                url: tile.url,
                                x: tile.x,
                                y: tile.y,
                                z: tile.z
                            });
                            resolve();
                        });
                });
            });
            
            return Promise.all(promises);
        }
        
        // 恢复照片数据
        function restorePhotos(photos, total) {
            if (photos.length === 0) {
                hideProgress();
                return;
            }
            
            const photo = photos.shift();
            const processed = total - photos.length;
            const percent = 50 + (processed / total) * 50;
            
            showProgress('导入数据', `恢复照片 (${processed}/${total})...`, percent);
            
            // 将dataURL转换为Blob
            fetch(photo.dataUrl)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], photo.filename, { type: blob.type });
                    
                    // 添加照片到地图
                    addPhotoToMap(file, photo.lat, photo.lng, photo);
                    
                    // 处理下一张照片
                    setTimeout(() => restorePhotos(photos, total), 100);
                });
        }
        
        // 修改addPhotoToMap函数以支持导入数据
        function addPhotoToMap(file, lat, lng, photoData = null) {
            // 创建照片缩略图
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 创建缩略图
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 60; // 缩略图大小
                    
                    // 计算缩略图尺寸，保持宽高比
                    let width = size;
                    let height = size;
                    
                    if (img.width > img.height) {
                        height = (size * img.height) / img.width;
                    } else {
                        width = (size * img.width) / img.height;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    
                    // 创建自定义标记
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'photo-marker fade-in',
                            html: `<img src="${dataUrl}" alt="Photo">`,
                            iconSize: [width, height],
                            iconAnchor: [width/2, height/2]
                        })
                    });
                    
                    // 存储照片数据（包括缩略图尺寸）
                    marker.photoData = {
                        file: file,
                        dataUrl: dataUrl,
                        lat: lat,
                        lng: lng,
                        width: img.width,
                        height: img.height,
                        thumbWidth: width,  // 保存缩略图宽度
                        thumbHeight: height, // 保存缩略图高度
                        timestamp: photoData ? photoData.timestamp : new Date().toLocaleString() // 添加时间戳
                    };
                    
                    // 添加点击事件
                    marker.on('click', function() {
                        showPhotoViewer([marker], 0);
                    });
                    
                    // 添加到地图
                    marker.addTo(map);
                    photoMarkers.push(marker);
                    
                    // 更新照片聚类
                    updatePhotoClusters();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 显示右键菜单
        function showContextMenu(x, y, latlng) {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            
            // 保存点击位置
            contextMenuLocation = latlng;
        }
        
        // 隐藏右键菜单
        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'none';
            contextMenuLocation = null;
        }
        
        // 在右键菜单位置添加照片
        function addPhotoAtContextMenuLocation() {
            if (!contextMenuLocation) return;
            
            // 触发文件选择
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = true;
            
            fileInput.onchange = function(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    // 直接在地图点击位置添加照片，忽略EXIF信息
                    addPhotoToMap(file, contextMenuLocation.lat, contextMenuLocation.lng);
                }
                
                // 隐藏右键菜单
                hideContextMenu();
            };
            
            fileInput.click();
        }
        
        // 处理照片上传
        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                // 读取EXIF数据获取位置信息
                EXIF.getData(file, function() {
                    const lat = EXIF.getTag(this, 'GPSLatitude');
                    const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                    const lng = EXIF.getTag(this, 'GPSLongitude');
                    const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');
                    
                    let latitude, longitude;
                    
                    if (lat && lng) {
                        // 转换EXIF坐标格式为十进制
                        latitude = convertDMSToDD(lat[0], lat[1], lat[2], latRef);
                        longitude = convertDMSToDD(lng[0], lng[1], lng[2], lngRef);
                        
                        // 添加照片到地图
                        addPhotoToMap(file, latitude, longitude);
                    } else {
                        // 没有位置信息，提示用户输入
                        pendingPhotos.push(file);
                        
                        // 显示坐标输入模态框
                        const coordModal = new bootstrap.Modal(document.getElementById('coordModal'));
                        coordModal.show();
                    }
                });
            }
            
            // 清空文件选择器，允许重复选择相同文件
            event.target.value = '';
        }
        
        // 确认坐标输入
        function confirmCoordinates() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('请输入有效的经纬度坐标');
                return;
            }
            
            // 为所有待处理照片添加位置
            pendingPhotos.forEach(file => {
                addPhotoToMap(file, lat, lng);
            });
            
            // 清空待处理列表
            pendingPhotos = [];
            
            // 关闭模态框
            const coordModal = bootstrap.Modal.getInstance(document.getElementById('coordModal'));
            coordModal.hide();
        }
        
        // 更新照片聚类
        function updatePhotoClusters() {
            // 清空现有聚类
            for (const key in photoClusters) {
                map.removeLayer(photoClusters[key]);
            }
            photoClusters = {};
            
            // 按位置分组照片
            const groupedMarkers = {};
            const clusterDistance = 0.01; // 聚类距离（经纬度）
            
            photoMarkers.forEach(marker => {
                const lat = marker.getLatLng().lat;
                const lng = marker.getLatLng().lng;
                
                // 查找附近的现有聚类
                let foundCluster = false;
                for (const key in groupedMarkers) {
                    const [clusterLat, clusterLng] = key.split(',').map(Number);
                    const distance = Math.sqrt(Math.pow(lat - clusterLat, 2) + Math.pow(lng - clusterLng, 2));
                    
                    if (distance < clusterDistance) {
                        groupedMarkers[key].push(marker);
                        foundCluster = true;
                        break;
                    }
                }
                
                // 如果没有找到附近的聚类，创建新聚类
                if (!foundCluster) {
                    const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
                    groupedMarkers[key] = [marker];
                }
            });
            
            // 为每个组创建聚类标记
            for (const key in groupedMarkers) {
                const markers = groupedMarkers[key];
                
                if (markers.length > 1) {
                    // 创建聚类标记 - 显示叠加的照片
                    const centerLat = markers.reduce((sum, m) => sum + m.getLatLng().lat, 0) / markers.length;
                    const centerLng = markers.reduce((sum, m) => sum + m.getLatLng().lng, 0) / markers.length;
                    
                    // 创建叠加照片的HTML
                    let clusterHtml = '<div class="photo-cluster">';
                    
                    // 最多显示4张照片的叠加
                    const maxPhotosToShow = Math.min(4, markers.length);
                    for (let i = 0; i < maxPhotosToShow; i++) {
                        const rotation = (i - (maxPhotosToShow-1)/2) * 10; // 轻微旋转每张照片
                        const offsetX = (i - (maxPhotosToShow-1)/2) * 5; // X轴偏移
                        const offsetY = (i - (maxPhotosToShow-1)/2) * 5; // Y轴偏移
                        
                        // 获取照片的实际宽高比
                        const thumbWidth = markers[i].photoData.thumbWidth;
                        const thumbHeight = markers[i].photoData.thumbHeight;
                        const aspectRatio = thumbWidth / thumbHeight;
                        
                        // 根据宽高比设置显示尺寸
                        let displayWidth, displayHeight;
                        if (aspectRatio > 1) {
                            // 横版照片
                            displayWidth = i === 0 ? 60 : 50;
                            displayHeight = displayWidth / aspectRatio;
                        } else {
                            // 竖版照片
                            displayHeight = i === 0 ? 60 : 50;
                            displayWidth = displayHeight * aspectRatio;
                        }
                        
                        clusterHtml += `
                            <div class="cluster-photo" style="
                                transform: rotate(${rotation}deg);
                                z-index: ${maxPhotosToShow - i};
                                left: ${offsetX}px;
                                top: ${offsetY}px;
                                width: ${displayWidth}px;
                                height: ${displayHeight}px;
                            ">
                                <img src="${markers[i].photoData.dataUrl}" alt="Photo">
                            </div>
                        `;
                    }
                    
                    // 添加照片数量指示器（在下方显示）
                    if (markers.length > maxPhotosToShow) {
                        clusterHtml += `<div class="cluster-count">+${markers.length - maxPhotosToShow + 1}</div>`;
                    }
                    
                    clusterHtml += '</div>';
                    
                    const cluster = L.marker([centerLat, centerLng], {
                        icon: L.divIcon({
                            className: 'fade-in',
                            html: clusterHtml,
                            iconSize: [80, 80],
                            iconAnchor: [40, 40]
                        })
                    });
                    
                    // 添加点击事件
                    cluster.on('click', function() {
                        showPhotoViewer(markers, 0);
                    });
                    
                    // 添加到地图和聚类对象
                    cluster.addTo(map);
                    photoClusters[key] = cluster;
                    
                    // 隐藏单个标记
                    markers.forEach(marker => {
                        map.removeLayer(marker);
                    });
                } else {
                    // 单个照片，确保显示在地图上
                    if (!map.hasLayer(markers[0])) {
                        markers[0].addTo(map);
                    }
                }
            }
        }
        
        // 显示照片查看器
        function showPhotoViewer(markers, index) {
            currentViewerMarkers = markers;
            currentPhotoIndex = index;
			// 隐藏导航栏
			document.querySelector('.navbar').classList.add('navbar-hidden');
			
			// 隐藏地图缩放控件
			const zoomControl = document.querySelector('.leaflet-control-zoom');
			if (zoomControl) {
				zoomControl.classList.add('leaflet-control-zoom-hidden');
			}
			    
            // 显示地图蒙版
            document.getElementById('mapOverlay').style.display = 'block';
            
            // 显示照片查看器
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.style.display = 'flex';
            
            // 更新照片显示
            updatePhotoDisplay();
            
            // 更新预览小图
            updatePhotoPreviews();
            
            // 关闭详情面板（如果打开）
            closeDetails();
            
            // 添加动画效果
            setTimeout(() => {
                photoViewer.classList.add('slide-in');
            }, 10);
        }
        
        // 更新照片显示
        function updatePhotoDisplay() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const mainPhoto = document.getElementById('mainPhoto');
            
            // 创建照片URL
            const photoUrl = URL.createObjectURL(marker.photoData.file);
            mainPhoto.src = photoUrl;
            
            // 更新详情信息
            updatePhotoDetails();
        }
        
        // 更新照片预览
        function updatePhotoPreviews() {
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = '';
            
            // 最多显示8张预览图
            const maxPreviews = Math.min(8, currentViewerMarkers.length);
            
            for (let i = 0; i < maxPreviews; i++) {
                const marker = currentViewerMarkers[i];
                const previewItem = document.createElement('div');
                previewItem.className = `preview-item ${i === currentPhotoIndex ? 'active' : ''}`;
                
                const img = document.createElement('img');
                img.src = marker.photoData.dataUrl;
                img.alt = `预览图 ${i + 1}`;
                
                // 如果照片数量超过4张，添加数量指示器
                if (i === maxPreviews - 1 && currentViewerMarkers.length > maxPreviews) {
                    const countIndicator = document.createElement('div');
                    countIndicator.className = 'photo-count-indicator';
                    countIndicator.textContent = `+${currentViewerMarkers.length - maxPreviews + 1}`;
                    previewItem.appendChild(countIndicator);
                }
                
                previewItem.appendChild(img);
                previewItem.addEventListener('click', () => {
                    navigateToPhoto(i);
                });
                
                photoPreview.appendChild(previewItem);
            }
            
            // 添加总照片数量显示
            if (currentViewerMarkers.length > 4) {
                const totalCount = document.createElement('div');
                totalCount.className = 'total-photo-count';
                totalCount.textContent = `${currentPhotoIndex + 1}/${currentViewerMarkers.length}`;
                photoPreview.appendChild(totalCount);
            }
        }
        
        // 更新照片详情
        function updatePhotoDetails() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            
            document.getElementById('detailLocation').textContent = 
                `${marker.photoData.lat.toFixed(6)}, ${marker.photoData.lng.toFixed(6)}`;
            
            document.getElementById('detailDimensions').textContent = 
                `${marker.photoData.width} × ${marker.photoData.height}`;
            
            document.getElementById('detailFilename').textContent = 
                marker.photoData.file.name;
            
            document.getElementById('detailTimestamp').textContent = 
                marker.photoData.timestamp;
        }
        
        // 导航到指定照片
        function navigateToPhoto(index) {
            if (index < 0 || index >= currentViewerMarkers.length) return;
            
            currentPhotoIndex = index;
            updatePhotoDisplay();
            updatePhotoPreviews();
        }
        
        // 导航照片（向前或向后）
        function navigatePhoto(direction) {
            let newIndex = currentPhotoIndex + direction;
            
            // 循环导航
            if (newIndex < 0) {
                newIndex = currentViewerMarkers.length - 1;
            } else if (newIndex >= currentViewerMarkers.length) {
                newIndex = 0;
            }
            
            navigateToPhoto(newIndex);
        }
        
        // 关闭照片查看器
        function closePhotoViewer() {
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.style.display = 'none';
            photoViewer.classList.remove('slide-in');
            
			// 显示导航栏
			document.querySelector('.navbar').classList.remove('navbar-hidden');
			// 显示地图缩放控件
			const zoomControl = document.querySelector('.leaflet-control-zoom');
			if (zoomControl) {
				zoomControl.classList.remove('leaflet-control-zoom-hidden');
			}
            // 隐藏地图蒙版
            document.getElementById('mapOverlay').style.display = 'none';
            
            // 释放URL对象
            currentViewerMarkers.forEach(marker => {
                if (marker.photoData.file) {
                    URL.revokeObjectURL(marker.photoData.file);
                }
            });
            
            currentViewerMarkers = [];
            currentPhotoIndex = 0;
        }
        
        // 删除当前照片
        function deleteCurrentPhoto() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const markerIndex = photoMarkers.indexOf(marker);
            
            if (markerIndex >= 0) {
                // 从地图移除标记
                map.removeLayer(marker);
                
                // 从数组中移除
                photoMarkers.splice(markerIndex, 1);
                
                // 从当前查看器中移除
                currentViewerMarkers.splice(currentPhotoIndex, 1);
                
                // 如果还有照片，显示下一张或前一张
                if (currentViewerMarkers.length > 0) {
                    if (currentPhotoIndex >= currentViewerMarkers.length) {
                        currentPhotoIndex = currentViewerMarkers.length - 1;
                    }
                    updatePhotoDisplay();
                    updatePhotoPreviews();
                } else {
                    // 没有照片了，关闭查看器
                    closePhotoViewer();
                }
                
                // 更新聚类
                updatePhotoClusters();
            }
        }
        
        // 切换详情面板
        function toggleDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            if (isDetailsOpen) {
                detailsPanel.classList.remove('open');
            } else {
                detailsPanel.classList.add('open');
            }
            isDetailsOpen = !isDetailsOpen;
        }
        
        // 关闭详情面板
        function closeDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            detailsPanel.classList.remove('open');
            isDetailsOpen = false;
        }
        
        // 下载当前照片
        function downloadCurrentPhoto() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const link = document.createElement('a');
            link.href = URL.createObjectURL(marker.photoData.file);
            link.download = marker.photoData.file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 清除所有照片
        function clearAllPhotos() {
            if (confirm('确定要删除所有照片吗？')) {
                // 移除所有标记
                photoMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
                
                // 移除所有聚类
                for (const key in photoClusters) {
                    map.removeLayer(photoClusters[key]);
                }
                
                // 清空数组
                photoMarkers = [];
                photoClusters = {};
                
                // 如果照片查看器是打开的，关闭它
                closePhotoViewer();
            }
        }
        
        // 转换度分秒坐标为十进制
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = degrees + minutes / 60 + seconds / 3600;
            
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            
            return dd;
        }
        
        // 页面加载完成后初始化地图
        window.onload = initMap;
    </script>
</body>
</html>